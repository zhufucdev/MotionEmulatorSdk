package com.zhufucdev.me.stub

import com.aventrix.jnanoid.jnanoid.NanoIdUtils
import kotlinx.serialization.json.Json
import kotlinx.serialization.serializer
import org.junit.Test

import org.junit.Assert.*
import kotlin.math.sqrt
import kotlin.random.Random

class SaltUnitTest {
    private val salts = buildList {
        add(
            Json.decodeFromString(
                serializer<Salt2dData>(),
                """
                    {
                        "id": "mAA1-o_maQO6LEEoApO9-",
                        "elements": [
                          {
                            "values": [
                              "centerX",
                              "centerY"
                            ],
                            "type": "Anchor"
                          },
                          {
                            "values": [
                              "10",
                              "1"
                            ],
                            "type": "Scale"
                          },
                          {
                            "values": [
                              "centerX",
                              "centerY"
                            ],
                            "type": "Anchor"
                          },
                          {
                            "values": [
                              "1",
                              "0"
                            ],
                            "type": "Translation"
                          }
                        ]
                    }
        """
            ).runtime()
        )

        add(
            Json.decodeFromString(
                serializer<Salt2dData>(),
                """
                {
                    "id": "cxvwOuzEtZn5TPpoDBc8r",
                    "elements": [
                      {
                        "values": [
                          "centerX",
                          "centerY"
                        ],
                        "type": "Anchor"
                      },
                      {
                        "values": [
                          "2pi*x",
                          "1"
                        ],
                        "type": "Rotation"
                      }
                    ],
                    "factors": [
                      {
                        "id": "rCWv04jqn-V25ehC1QE4q",
                        "name": "x",
                        "distribution": [
                          0.013320762980579678,
                          0.7749852671986937,
                          0.957235394883454,
                          0.38061790932495787
                        ]
                      }
                    ]
                  }
            """
            ).runtime()
        )
    }
    private val trace by lazy {
        Trace(
            id = NanoIdUtils.randomNanoId(),
            listOf(
                Point(-1.0, -1.0),
                Point(-1.0, 1.0),
                Point(1.0, 1.0),
                Point(1.0, -1.0)
            )
        )
    }
    private val trace2 by lazy {
        Json.decodeFromString<Trace>(
            """{"id":"KE4IB0M-HNh2JyA1OeSrY","points":[[32.201312412397925,118.71214022802896],[32.20131127758083,118.71213486361101],[32.20130560349518,118.71211474704376],[32.20129312050551,118.71208658384958],[32.20128971605348,118.71207719611819],[32.20128517678392,118.7120678083868],[32.20128063751413,118.71206110286438],[32.20127723306164,118.71205305623747],[32.20127382860901,118.71204635071506],[32.20127042415627,118.7120396451926],[32.20126815452103,118.71203159856572],[32.201263615250376,118.71202489304328],[32.20126021079726,118.7120155053119],[32.20125567152622,118.71200879978947],[32.2012499974371,118.71199941205808],[32.20124545816556,118.71199270653565],[32.20123978407581,118.71198465990874],[32.201232975167635,118.71197527217736],[32.20122616625896,118.71196588444597],[32.201218222531516,118.7119551556101],[32.20121141362173,118.7119471089832],[32.201203469893,118.71193906235628],[32.20119439134504,118.71193101572936],[32.20118644761483,118.71192431020695],[32.20117850388393,118.71191894578902],[32.201170560152335,118.71191224026659],[32.201162616420035,118.71190687584865],[32.20115580750609,118.71190151143071],[32.201148998591634,118.71189614701278],[32.20114218967667,118.71188944149036],[32.20113424594191,118.71188407707241],[32.20112743702584,118.71187871265448],[32.20112062810925,118.7118760304455],[32.201113819192166,118.71187066602758],[32.20110587545493,118.71186530160962],[32.201100201356454,118.71186127829617],[32.20109225761803,118.71185725498272],[32.201084313878894,118.71185457277375],[32.20107637013908,118.7118505494603],[32.201068426398564,118.71184652614684],[32.201060482657354,118.71184384393787],[32.20105253891544,118.71183982062442],[32.20104459517285,118.71183713841546],[32.201035516609025,118.7118317739975],[32.20102757286495,118.71182909178854],[32.201020763940896,118.7118250684751],[32.20101282019553,118.71182238626612],[32.20100601127037,118.71181836295267],[32.200999202344704,118.71181568074371],[32.20099352823959,118.71181433963922],[32.200986719312986,118.71181165743025],[32.20097991038589,118.71181031632575],[32.20097196663695,118.7118076341168],[32.20096515770874,118.7118062930123],[32.20094359609936,118.71180226969886],[32.20092997823818,118.71180226969886],[32.20091863001897,118.71180092859437],[32.200907281798344,118.71180092859437],[32.2008959335763,118.71179958748988],[32.200884585352846,118.71179824638541],[32.20087323712797,118.71179824638541],[32.20086188890169,118.71179824638541],[32.20085167549682,118.71179690528092],[32.20084486655959,118.71179556417643],[32.20083805762187,118.71179422307196],[32.200830113860555,118.71179288196747],[32.20082103527533,118.7117901997585],[32.20081309151252,118.7117901997585],[32.200806282572415,118.711788858654],[32.20079720398482,118.71178751754954],[32.200785855749054,118.71178617644505],[32.20077450751186,118.71178483534055],[32.20076429409719,118.71178483534055],[32.20075181103325,118.71178349423609],[32.200740462791806,118.71178349423609],[32.20072911454895,118.7117821531316],[32.2007177663047,118.7117821531316],[32.20070528323437,118.7117821531316],[32.200693934987136,118.7117821531316],[32.20068485638833,118.71178483534055],[32.200675777788625,118.71178617644505],[32.20066896883824,118.71178751754954],[32.200661025062146,118.71178751754954],[32.20065081163472,118.711788858654],[32.200642867857056,118.7117901997585],[32.2006349240787,118.71179154086299],[32.20062698029963,118.71179288196747],[32.20061790169414,118.71179288196747],[32.20060882308775,118.71179556417643],[32.20059974448045,118.71179690528092],[32.20059066587224,118.71179958748988],[32.20058158726313,118.71180226969886],[32.20057023900046,118.71180361080334],[32.20054640764426,118.71180897522129],[32.20053052006999,118.7118076341168],[32.200519171800956,118.71181031632575],[32.20050555387624,118.71180897522129],[32.200495340431374,118.71181299853474],[32.200483992157956,118.71181433963922],[32.20047264388311,118.71181568074371],[32.20044540801773,118.71181970405716],[32.20043405973807,118.71182372737061],[32.200420441800624,118.71182775068408],[32.20040682386114,118.7118317739975],[32.20039547557668,118.71183445620649],[32.20038753177671,118.71183713841546],[32.20038072280475,118.71183847951995],[32.200371644174695,118.71184116172891],[32.20036256554371,118.71184384393787],[32.20035121725374,118.71184786725134],[32.20034100379154,118.7118505494603],[32.20033192515752,118.71185323166928],[32.20032171169316,118.71185591387824],[32.20031376788676,118.71185859608721],[32.20030355442036,118.71186127829617],[32.20029447578259,118.71186396050516],[32.20028426231403,118.7118679838186],[32.20027631850434,118.71187066602758],[32.20026723986387,118.71187468934103],[32.200258161222486,118.71187737154999],[32.200246812919474,118.71188139486345],[32.20023886910652,118.7118854181769],[32.200229790462316,118.71188944149036],[32.200221846647885,118.71189346480382],[32.200215037663526,118.71189748811724],[32.20020709384781,118.71190151143071],[32.20020141969331,118.7119028525352],[32.20019574553844,118.71190553474416],[32.20019007138322,118.71190821695312],[32.20018326239648,118.71190955805761],[32.200178723071716,118.71191224026659],[32.20017418374672,118.71191492247557],[32.2001696444215,118.71191626358004],[32.200163970264654,118.71191894578902],[32.20015943093892,118.71192028689349],[32.20015489161297,118.71192296910246],[32.20015035228678,118.71192431020695],[32.20014467812873,118.71192699241591],[32.200140138802034,118.7119296746249],[32.20013446464334,118.71193101572936],[32.200128790484314,118.71193369793833],[32.20012198149299,118.71193638014732],[32.200117442165165,118.71193772125179],[32.20011290283711,118.71193906235628],[32.20010722867673,118.71194040346077],[32.200102689348164,118.71194308566973],[32.20009701518715,118.71194442677422],[32.200092475858064,118.7119471089832],[32.200085666864034,118.71194979119215],[32.2000811275344,118.71195113229665],[32.20007658820453,118.7119551556101],[32.200072048874446,118.71195917892354],[32.20006297021357,118.71196454334148],[32.200057296050076,118.71196588444597],[32.20005275671903,118.71196990775944],[32.20004708255489,118.7119725899684],[32.2000414083904,118.71197527217736],[32.20003686905855,118.71197929549082],[32.20003119489343,118.71198197769978],[32.20002665556107,118.71198331880427],[32.200020981395305,118.71198600101323],[32.20001644206245,118.71198734211772],[32.200010767896046,118.71199270653565],[32.20000509372928,118.71199538874464],[32.199999419562175,118.71199941205808],[32.19999488022824,118.71200209426706],[32.19997445322269,118.71201952862535],[32.19996877905367,118.71202489304328],[32.19996197005038,118.71203159856572],[32.199954026212566,118.71204232740159],[32.199944947539926,118.71205171513297],[32.19993132952927,118.71206914949127],[32.1999199811855,118.71208256053613],[32.199909767674896,118.71209463047647],[32.19989955416315,118.71210804152133],[32.19989047548507,118.71211877035721],[32.19988366647592,118.71212949919308],[32.19987572263126,118.7121362047155],[32.19987231812621,118.71214291023793],[32.199863239445406,118.7121549801783],[32.199858700104684,118.7121630268052],[32.199856430434224,118.71217241453658],[32.19985189109314,118.7121804611635],[32.199847351751835,118.71218850779042],[32.19984281241032,118.7121978955218],[32.19983940790402,118.71220728325316],[32.1998348685621,118.71221667098457],[32.19983259889105,118.71222471761149],[32.199830329219935,118.71223008202942],[32.199828059548786,118.71223678755183],[32.199825789877565,118.71224617528324],[32.199823520206294,118.71225958632807],[32.199823520206294,118.71226897405946],[32.199824655041944,118.71227567958191],[32.199822385370624,118.71228238510432],[32.199822385370624,118.71228909062674],[32.199820115699275,118.71229579614915],[32.199818980863576,118.71230384277607],[32.199818980863576,118.71231188940298],[32.199818980863576,118.71231993602987],[32.19981784602786,118.71232932376128],[32.19981784602786,118.71233737038818],[32.19982125053496,118.71234541701507],[32.199820115699275,118.71235212253752],[32.19982125053496,118.7123601691644],[32.199823520206294,118.71236553358236],[32.199825789877565,118.71237089800027],[32.199826924713186,118.71238430904515],[32.199830329219935,118.71239101456756],[32.19983259889105,118.71240710782136],[32.1998360033976,118.71241247223931],[32.19983940790402,118.71242185997069],[32.199840542739466,118.71242722438863],[32.199840542739466,118.71243392991106],[32.19984281241032,118.712439294329],[32.199845082081104,118.71244599985143],[32.199845082081104,118.71245404647834],[32.199847351751835,118.71246075200075],[32.19984962142252,118.71246611641868],[32.19985189109314,118.7124728219411],[32.19985983493988,118.7124996440308],[32.19987458779625,118.71252914832947],[32.19987572263126,118.71253585385188],[32.1998791271362,118.71254121826983],[32.199881396806084,118.71254658268775],[32.19988480131081,118.71255194710571],[32.199888205815405,118.71255731152363],[32.19989047548507,118.71256267594158],[32.19989387998945,118.7125680403595],[32.19989728449371,118.71257340477746],[32.19990295866718,118.71258413361333],[32.199908632840305,118.71259352134471],[32.19991203734401,118.71259754465817],[32.199917711516576,118.71260559128508],[32.19992338568878,118.71261497901646],[32.19992905986063,118.71262436674786],[32.19993246436357,118.71262973116579],[32.19993586886639,118.71263509558374],[32.19994154303746,118.71264314221065],[32.19994608237406,118.7126471655241],[32.199950621710435,118.71265252994203],[32.19995516104659,118.71265789435998],[32.199958565548556,118.7126645998824],[32.199963104884304,118.71266996430033],[32.199967644219825,118.71267532871828],[32.199972183555126,118.7126806931362],[32.19997558805645,118.71268605755415],[32.199980127391356,118.7126900808676],[32.19998693639329,118.71269812749452],[32.199991475727636,118.71270215080796],[32.2000039588959,118.71271690295728],[32.200010767896046,118.71272092627073],[32.20001871172891,118.71272629068869],[32.20002665556107,118.71273165510661],[32.20004027355746,118.71274104283802],[32.20004821738774,118.71274506615147],[32.20005275671903,118.71274506615147],[32.20006183538091,118.7127504305694],[32.20006977920931,118.71275311277836],[32.20007431853952,118.71275445388285],[32.2000788578695,118.71275713609182],[32.20008339719924,118.71275847719632],[32.20008793652876,118.71276115940528],[32.200092475858064,118.71276250050977],[32.20009815001937,118.71276518271873],[32.200103824180324,118.71276652382322],[32.200109498340915,118.71276920603219],[32.200115172501164,118.71276920603219],[32.20011971182911,118.71277188824115],[32.20012538598871,118.71277457045014],[32.20013106014797,118.7127759115546],[32.2001378691386,118.71277859376357],[32.20014467812873,118.71278127597256],[32.2001492174552,118.71278261707702],[32.200156026444475,118.71278529928601],[32.20016283543325,118.71278529928601],[32.200168509590156,118.71278664039048],[32.200175318578,118.71278798149497],[32.200186666889905,118.71279066370394],[32.20019574553844,118.71279200480843],[32.20021049834035,118.7127946870174],[32.200221846647885,118.7127946870174],[32.20023092529289,118.7127946870174],[32.20023659944557,118.7127946870174],[32.200244543258705,118.71279602812189],[32.20025021741053,118.71279602812189],[32.200258161222486,118.71279736922635],[32.20026610503375,118.71279736922635],[32.20027291401428,118.71279736922635],[32.20028199265419,118.71279736922635],[32.20028993646337,118.71279736922635],[32.20029674544212,118.71279602812189],[32.200304689250004,118.71279736922635],[32.200311498227656,118.71279602812189],[32.20031830720478,118.71279602812189],[32.20032284652259,118.71279602812189],[32.20032965549888,118.7127946870174],[32.20033419481611,118.7127946870174],[32.20033873413312,118.7127933459129],[32.20034554310822,118.7127933459129],[32.20035121725374,118.71279200480843],[32.200358026227896,118.71279200480843],[32.20036370037264,118.71279200480843],[32.200370509345866,118.71279200480843],[32.20037504866107,118.71279066370394],[32.20038072280475,118.71279200480843],[32.20038639694808,118.71279066370394],[32.20039093626249,118.71279066370394],[32.20039661040518,118.71279066370394],[32.20040909351785,118.71279066370394],[32.200413632831136,118.71279066370394],[32.20041817214418,118.71279066370394],[32.200423846285176,118.71279066370394],[32.20042838559772,118.71278932259945],[32.200432924910025,118.71278932259945],[32.2004385990501,118.71278932259945],[32.20044767767348,118.71278932259945],[32.20045562146819,118.71278932259945],[32.20046129560685,118.71278798149497],[32.200470374227976,118.71278798149497],[32.20047718319321,118.71278798149497],[32.2004817225031,118.71278664039048],[32.200488531467485,118.71278664039048],[32.2004930707768,118.71278664039048],[32.20049761008588,118.71278664039048],[32.200503284221924,118.71278529928601],[32.2005078235305,118.71278529928601],[32.20051463249294,118.71278395818152],[32.20052030662791,118.71278395818152],[32.200524845935654,118.71278261707702],[32.200531654896814,118.71278395818152],[32.200539598684195,118.71278395818152],[32.200549812124095,118.71278261707702],[32.20055889073638,118.71278261707702],[32.20056456486859,118.71278261707702],[32.2005713738268,118.71278127597256],[32.20057704795822,118.71278127597256],[32.200582722089315,118.71277993486807],[32.20058839622005,118.71277859376357],[32.20059520517645,118.71277859376357],[32.20060201413236,118.71277859376357],[32.2006099579136,118.71277859376357],[32.20061563204262,118.7127772526591],[32.200625845473986,118.7127759115546],[32.200638328555215,118.71277457045014],[32.200646272333294,118.71277322934564],[32.200651946460056,118.71277322934564],[32.20065762058647,118.71277188824115],[32.200663294712534,118.71277054713669],[32.20067123848842,118.71277054713669],[32.20067804743863,118.71276652382322],[32.200685991213234,118.71276652382322],[32.20069506981193,118.71276518271873],[32.200701878760356,118.71276518271873],[32.200709822532865,118.71276384161423],[32.200716631480205,118.71275981830081],[32.200722305602575,118.71275981830081],[32.200730249373315,118.71275981830081],[32.20073705831911,118.71275579498734],[32.20074500208857,118.71275579498734],[32.20075181103325,118.7127517716739],[32.20075861997742,118.7127504305694],[32.20076656374499,118.7127504305694],[32.20077337268807,118.71274640725595],[32.200781316454346,118.71274372504698],[32.200788125396315,118.71274506615147],[32.2007960691613,118.71274104283802],[32.20080287810218,118.71274104283802],[32.20080968704253,118.71273970173353],[32.20081649598239,118.71273701952457],[32.20082330492173,118.7127343373156],[32.20083124868364,118.7127343373156],[32.20083805762187,118.71273031400214],[32.20084486655959,118.71273165510661],[32.20085167549682,118.71272763179316],[32.20085848443352,118.71272763179316],[32.20086415854705,118.7127249495842],[32.20087096748283,118.71272226737523],[32.20088118088553,118.71271958516627],[32.20089479875403,118.71271556185282],[32.200903877331875,118.71271287964383],[32.20091182108676,118.71271019743486],[32.200917495196975,118.7127088563304],[32.20092203448488,118.71270617412141],[32.20092884341632,118.7127075152259],[32.200933382703674,118.71270349191245],[32.20093905681252,118.71270080970348],[32.200945865742696,118.71270215080796],[32.20095153985078,118.71269812749452],[32.20095721395851,118.71269544528553],[32.20096288806589,118.71269410418107],[32.200968562172896,118.71269142197208],[32.20097423627957,118.7126900808676],[32.20097991038589,118.71268739865862],[32.200986719312986,118.71268471644966],[32.20099125859745,118.71268605755415],[32.20099466306064,118.7126820342407],[32.200999202344704,118.7126806931362],[32.20100487644946,118.7126806931362],[32.201009415733004,118.71267801092723],[32.201015089837135,118.71267801092723],[32.201020763940896,118.71267398761378],[32.20102530322366,118.71267264650932],[32.201029842506195,118.71267398761378],[32.201035516609025,118.71266996430033],[32.201040055891056,118.71266996430033],[32.20104459517285,118.71266728209136],[32.201053673735764,118.7126645998824],[32.20105821301688,118.71266594098687],[32.20106275229777,118.71266191767342],[32.20106729157843,118.71266325877791],[32.201071830858865,118.71265923546446],[32.201079774599094,118.71265655325548],[32.20108885315849,118.71265521215099],[32.20109679689721,118.71264984773308],[32.201101336176194,118.71265118883754],[32.20110701027458,118.7126471655241],[32.201111549553026,118.71264582441961],[32.201116088831256,118.71264314221065],[32.20112062810925,118.71264046000167],[32.20112970666458,118.71263643668821],[32.20114105485746,118.71263107227028],[32.201145594134225,118.71262839006133],[32.20115126822984,118.71262704895683],[32.20115580750609,118.71262436674786],[32.201162616420035,118.71261900232992],[32.20116715569573,118.71261766122545],[32.20117169497117,118.71261363791199],[32.201176234246404,118.71260961459853],[32.20118077352141,118.71260827349404],[32.201185312796184,118.71260425018059],[32.201189852070726,118.71260156797162],[32.20119439134504,118.71259754465817],[32.20119893061914,118.71259352134471],[32.201206874348266,118.71258681582229],[32.20121368325839,118.71258145140436],[32.20121935734977,118.71257608698642],[32.201227301077104,118.712569381464],[32.20123637962179,118.71256267594158],[32.20123978407581,118.71255865262812],[32.20124432334763,118.71255597041916],[32.20124772780136,118.71255060600122],[32.20125567152622,118.71254390047879],[32.20125907597952,118.71253987716534],[32.20126701970339,118.71253317164292],[32.20127042415627,118.71252914832947],[32.20127382860901,118.712525125016],[32.20127723306164,118.71252110170255],[32.2012817723316,118.71251573728462],[32.20128517678392,118.71251037286667],[32.20128971605348,118.71250098513529],[32.20129879459194,118.71248355077698],[32.20130219904362,118.7124741630456],[32.20130673831234,118.71246477531422],[32.20131468203205,118.71244599985143],[32.201319221300146,118.71243661212002],[32.20132262575106,118.71242588328414],[32.20132603020186,118.71241649555276],[32.20132829983564,118.71240308450793],[32.20133397391989,118.71238430904515],[32.20133624355348,118.71237089800027],[32.20133964800377,118.71235882805993],[32.201340782820495,118.71234675811957],[32.201341917637215,118.71234139370165],[32.201341917637215,118.71230518388053],[32.201341917637215,118.71228909062674],[32.201341917637215,118.71226092743257],[32.20133964800377,118.71224349307425],[32.201335108736686,118.71220862435767],[32.20132829983564,118.71218448447695],[32.201319221300146,118.71215900349175]],"salt":{"id":"OeSzZxOsmJqyltSq0GuNw","elements":[{"values":["centerX","centerY"],"type":"Anchor"},{"values":["0.001","0.001"],"type":"Scale"}]}}"""
        )
    }

    @Test
    fun transformers_parsing_correct() {
        val resolution = salts[0].resolve(BypassProjector, trace)
        assertEquals("size not match", 2, resolution.size)
        assertEquals("size of transforms not match", 1, resolution[0].transforms.size)
        assertEquals("type of transforms not match", TransformationChain::class, resolution[0].transforms[0]::class)
        // TODO: complete this shit
    }

    @Test
    fun center_correct() {
        val resolution = salts[0].resolve(BypassProjector, trace)
        assertEquals("anchor not match", Vector2D.zero, resolution[1].anchor)
    }

    @Test
    fun transform1_correct() {
        val testPoint = Vector2D.one
        val transformed = salts[0].apply(point = testPoint, parent = trace)
        assertEquals("x not match", 11.0, transformed.x, 1e-6)
        assertEquals("y not match", 1.0, transformed.y, 1e-6)
    }

    @Test
    fun transform2_correct() {
        val testPoint = Vector2D.one
        val transformed = salts[1].apply(point = testPoint, parent = trace)
        assertEquals("not in radius", sqrt(2.0), transformed.lenTo(Vector2D.zero), 1e-6)
    }

    @Test
    fun transform3_correct() {
        val center = trace2.center(MapProjector)
        val points = mutableListOf<Vector2D>()
        val references = mutableListOf<Vector2D>()
        val salted = trace2.generateSaltedTrace()
        repeat(10) {
            val p = Random.nextFloat()
            points.add(salted.at(p, MapProjector).point)
            references.add(trace2.points.at(p, MapProjector).point)
        }

        points.forEachIndexed { index, point ->
            val dp = with(MapProjector) { point.distance(center) }
            val dr = with(MapProjector) { references[index].distance(center) * 0.05 }
            assertEquals("far from center", dr, dp, 5.0)
        }
    }
}